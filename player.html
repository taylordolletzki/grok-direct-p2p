<!DOCTYPE html>
<html>
<head>
    <title>Grok Direct P2P Stream</title>
    <style>
        body { font-family: Arial; text-align: center; margin-top: 50px; }
        audio { width: 80%; max-width: 500px; }
        #status { font-size: 1.2em; margin: 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Stream Unlocked!</h2>
    <p id="status">Loading...</p>
    <audio id="player" controls preload="metadata"></audio>
    <button id="playBtn" style="display:none;">Play Song</button>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const trackId = urlParams.get("track");
            const ngrokUrl = 'https://taylor-music.ngrok.io';
            const wakeUrl = 'https://taylordolletzki.pythonanywhere.com/wake/a0:1b:c2:d3:e4:f5';

            if (!trackId) {
                document.getElementById("status").textContent = "No track ID — scan a valid QR.";
                return;
            }

            const audio = document.getElementById("player");
            const status = document.getElementById("status");
            const playBtn = document.getElementById("playBtn");

            status.textContent = "Loading stream...";
            audio.src = `${ngrokUrl}/${trackId}`;

            // Try to load stream
            audio.addEventListener('loadstart', () => {
                status.textContent = "Stream ready — tap play!";
                playBtn.style.display = 'block';
            });

            // If stream fails (Mac asleep), wake it
            audio.addEventListener('error', () => {
                console.log("Stream failed — waking Mac...");
                status.textContent = "Mac asleep — sending wake signal...";

                fetch(wakeUrl)
                    .then(() => {
                        status.textContent = "Wake signal sent! Retrying in 30s...";
                        setTimeout(() => location.reload(), 30000);
                    })
                    .catch(() => {
                        status.textContent = "Wake failed — check connection.";
                        playBtn.style.display = 'block';
                    });
            });

            // Manual play button
            playBtn.onclick = function() {
                audio.play().catch(e => {
                    console.error("Playback failed:", e);
                    status.textContent = "Playback failed — tap reload.";
                });
                playBtn.style.display = 'none';
            };

            // Auto-show play button when ready
            audio.addEventListener('canplay', () => {
                status.textContent = "Ready — tap play!";
                playBtn.style.display = 'block';
            });
        })();
    </script>
</body>
</html>
