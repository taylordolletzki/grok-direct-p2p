<!DOCTYPE html>
<html>
<head>
    <title>Grok Direct P2P Stream</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style> body { font-family: Arial; text-align: center; } audio { width: 100%; max-width: 400px; } </style>
</head>
<body>
    <h2>Stream Unlocked!</h2>
    <p id="status">Verifying payment...</p>
    <audio id="player" controls preload="metadata"></audio>

    <script>
        const socket = io("https://grok-relay.up.railway.app");
        const urlParams = new URLSearchParams(window.location.search);
        const trackId = urlParams.get("track");
        const txSig = urlParams.get("tx");  // From Solana Pay callback

        if (!trackId || !txSig) {
            document.getElementById("status").textContent = "Invalid QR scan. Use Solana Pay.";
            document.getElementById("player").style.display = "none";
            return;
        }

        socket.emit("request_stream", { track_id: trackId, tx_signature: txSig });

        socket.on("stream_ready", (data) => {
            document.getElementById("status").textContent = "Payment verified. Playing...";
            const audio = document.getElementById("player");
            audio.src = data.url + "?stream=1";  // Flag for chunking
            audio.play().catch(e => console.error("Playback error:", e));
        });

        socket.on("payment_failed", (data) => {
            document.getElementById("status").textContent = "Payment failed: " + data.error;
            document.getElementById("player").style.display = "none";
        });

        socket.on("error", (data) => {
            document.getElementById("status").textContent = data.msg;
        });
    </script>
</body>
</html>
